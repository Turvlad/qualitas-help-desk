<!DOCTYPE html>
<html lang="es" data-bs-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="color-scheme" content="light dark" />
    <title>Help Desk | Actividades</title>

    <!-- CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link href="css/theme.css" rel="stylesheet" />
  </head>

  <body>
    <div class="app-shell d-flex">
      <!-- Sidebar -->
      <aside class="sidebar d-flex flex-column p-3" aria-label="Barra lateral">
        <h1 class="h5 fw-bold mb-4">Help Desk</h1>

        <nav class="nav flex-column" aria-label="Navegaci√≥n principal">
          <a class="nav-link active" href="registro.html">
            <i class="bi bi-plus-circle" aria-hidden="true"></i>
            <span class="nav-label"> Registrar actividad</span>
          </a>

          <a class="nav-link" href="actividades.html">
            <i class="bi bi-list-task" aria-hidden="true"></i>
            <span class="nav-label"> Actividades colaboradores</span>
          </a>

          <a class="nav-link" href="kpis.html">
            <i class="bi bi-activity" aria-hidden="true"></i>
            <span class="nav-label"> Mis KPIs</span>
          </a>

          <a class="nav-link" href="kpis_admin.html">
            <i class="bi bi-bar-chart-steps" aria-hidden="true"></i>
            <span class="nav-label"> KPIs Admin</span>
          </a>

          <hr class="border-light my-3" />

          <div class="nav-item">
            <button
              class="nav-link d-flex align-items-center w-100 text-start bg-transparent border-0 px-0"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#perfilMenu"
              aria-expanded="false"
              aria-controls="perfilMenu"
            >
              <i class="bi bi-person-circle me-1" aria-hidden="true"></i>
              <span class="nav-label"> Mi Perfil</span>
              <i class="bi bi-caret-down ms-auto" aria-hidden="true"></i>
            </button>
            <div id="perfilMenu" class="collapse ps-3 mt-1">
              <a class="d-block small text-light" href="perfil.html">
                <i class="bi bi-person" aria-hidden="true"></i>
                <span class="nav-label"> Datos personales</span>
              </a>
              <a
                class="d-block small text-light mt-1"
                href="configuraciones.html"
              >
                <i class="bi bi-gear" aria-hidden="true"></i>
                <span class="nav-label"> Preferencias</span>
              </a>
            </div>
          </div>

          <hr class="border-light my-3" />

          <a class="nav-link" href="index.html">
            <i class="bi bi-box-arrow-right" aria-hidden="true"></i>
            <span class="nav-label"> Cerrar sesi√≥n</span>
          </a>
        </nav>
      </aside>

      <div class="app-main flex-grow-1 d-flex flex-column min-vh-100">
        <header>
          <nav class="navbar bg-white px-4" aria-label="Barra superior">
            <span class="navbar-brand h1 mb-0">Registrar Actividad</span>
      
            <div class="d-flex align-items-center gap-3 ms-auto">
              <span class="text-secondary small" data-usuario-nombre>Usuario</span>
              <span class="text-muted small" data-usuario-rol>Rol</span>
              <img
                src="https://placeholdmon.vercel.app/60x60"
                alt="Avatar de {data-uauario-nombre}"
                width="40"
                height="40"
                loading="lazy"
              />
            </div>
          </nav>
        </header>
      </div>

        <!-- Tabs: Registro general vs Renovaciones -->
        <div class="bg-white border-bottom">
          <div class="container-fluid px-4 py-3">
            <ul class="nav nav-pills gap-2" id="modeTabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button
                  class="nav-link active"
                  id="tab-general"
                  data-bs-toggle="pill"
                  data-bs-target="#pane-general"
                  type="button"
                  role="tab"
                  aria-controls="pane-general"
                  aria-selected="true"
                >
                  <i class="bi bi-list-task me-1" aria-hidden="true"></i>
                  Registro general
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button
                  class="nav-link"
                  id="tab-renov"
                  data-bs-toggle="pill"
                  data-bs-target="#pane-renov"
                  type="button"
                  role="tab"
                  aria-controls="pane-renov"
                  aria-selected="false"
                >
                  <i class="bi bi-shield-check me-1" aria-hidden="true"></i>
                  Renovaciones
                </button>
              </li>
            </ul>
          </div>
        </div>

        <main class="container-fluid py-4 tab-content" id="wizardModes">
          <!-- ===================== REGISTRO GENERAL (wizard existente) ===================== -->
          <div
            class="tab-pane fade show active"
            id="pane-general"
            role="tabpanel"
            aria-labelledby="tab-general"
          >
            <!-- STEPPER -->
            <div class="card border-0 shadow-sm mb-3">
              <div class="card-body">
                <div
                  class="stepper"
                  id="stepper"
                  aria-label="Pasos del registro"
                >
                  <div class="step active" data-step="1">
                    <div class="dot">1</div>
                    <div class="label">
                      Recepci√≥n, Solicitud y Env√≠o al √°rea
                    </div>
                  </div>
                  <i class="bi bi-chevron-right" aria-hidden="true"></i>
                  <div class="step" data-step="2">
                    <div class="dot">2</div>
                    <div class="label">Seguimiento</div>
                  </div>
                  <i class="bi bi-chevron-right" aria-hidden="true"></i>
                  <div class="step" data-step="3">
                    <div class="dot">3</div>
                    <div class="label">Env√≠o a Agente</div>
                  </div>
                  <i class="bi bi-chevron-right" aria-hidden="true"></i>
                  <div class="step" data-step="4">
                    <div class="dot">4</div>
                    <div class="label">Resumen</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- FORM SECTIONS (wizard) -->
            <form id="wizardForm" novalidate>
              <!-- header de navegaci√≥n -->
              <div
                class="sticky-footer d-flex justify-content-between align-items-center"
              >
                <button
                  type="button"
                  class="btn btn-outline-secondary"
                  id="btnPrev"
                  aria-label="Ir al paso anterior"
                >
                  <i class="bi bi-arrow-left-short me-1" aria-hidden="true"></i
                  >Atr√°s
                </button>
                <div class="d-flex align-items-center gap-2">
                  <button
                    type="button"
                    class="btn btn-outline-primary"
                    id="btnSave"
                  >
                    <i class="bi bi-cloud-arrow-up me-1" aria-hidden="true"></i
                    >Guardar borrador
                  </button>
                  <button type="button" class="btn btn-brand" id="btnNext">
                    Siguiente
                    <i
                      class="bi bi-arrow-right-short ms-1"
                      aria-hidden="true"
                    ></i>
                  </button>
                  <button
                    type="submit"
                    class="btn btn-success d-none"
                    id="btnSubmit"
                  >
                    <i class="bi bi-send-check me-1" aria-hidden="true"></i
                    >Enviar
                  </button>
                </div>
              </div>

              <!-- Paso 1: Recepci√≥n -->
              <section
                class="card border-0 shadow-sm card-section mb-3"
                data-step="1"
              >
                <div class="card-body">
                  <h2 class="h6 text-secondary fw-semibold mb-3">
                    <i class="bi bi-inbox me-2" aria-hidden="true"></i>Recepci√≥n
                  </h2>
                  <div class="row g-3">
                    <div class="col-md-4">
                      <label class="form-label" for="f-colaborador"
                        >Colaborador</label
                      >
                      <input
                        id="f-colaborador"
                        class="form-control"
                        name="colaborador"
                        placeholder="Tu nombre"
                        required
                        autocomplete="name"
                      />
                    </div>
                    <div class="col-md-4">
                      <label class="form-label" for="f-fecha">Fecha</label>
                      <input
                        id="f-fecha"
                        type="date"
                        class="form-control"
                        name="fecha"
                        required
                      />
                    </div>
                    <div class="col-md-4">
                      <label class="form-label" for="f-hrec"
                        >Hora de Recepci√≥n</label
                      >
                      <input
                        id="f-hrec"
                        type="time"
                        class="form-control"
                        name="hora_recepcion"
                        required
                      />
                    </div>
                  </div>
                </div>

                <div class="card-body">
                  <h2 class="h6 text-secondary fw-semibold mb-3">
                    <i class="bi bi-journal-text me-2" aria-hidden="true"></i
                    >Solicitud
                  </h2>
                  <div class="row g-3">
                    <div class="col-md-4">
                      <label class="form-label" for="f-agente"
                        >Agente Clave</label
                      >
                      <input
                        id="f-agente"
                        class="form-control"
                        name="agente_clave"
                        inputmode="numeric"
                        autocomplete="on"
                        required
                        minlength="5"
                        maxlength="5"
                        pattern="\d{5}"
                      />
                      <div class="invalid-feedback" id="agente-error">
                        La clave debe tener 5 d√≠gitos.
                      </div>
                      <div
                        id="agente-info"
                        class="form-text text-muted small"
                      ></div>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label" for="f-forma"
                        >Forma de Solicitud</label
                      >
                      <select
                        id="f-forma"
                        class="form-select"
                        name="forma_solicitud"
                        required
                      >
                        <option value="" selected disabled>Selecciona</option>
                        <option value="Email">Email</option>
                        <option value="Tel√©fono">Tel√©fono</option>
                        <option value="WhatsApp">WhatsApp</option>
                      </select>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label" for="f-tipo"
                        >Tipo de Solicitud</label
                      >
                      <select
                        id="f-tipo"
                        class="form-select"
                        name="tipo_solicitud"
                        required>
                          <option value="" selected disabled>Selecciona</option>
                          <option value="Aplicaci√≥n de Primas">Aplicaci√≥n de Primas</option>
                          <option value="Armar p√≥lizas (Impresi√≥n, CG)">Armar p√≥lizas (Impresi√≥n, CG)</option>
                          <option value="Cambio de Contratante">Cambio de Contratante</option>
                          <option value="Cambio de Titular">Cambio de Titular</option>
                          <option value="Cancelaci√≥n - Con dev primas">Cancelaci√≥n - Con dev primas</option>
                          <option value="Cancelaci√≥n - Sin dev primas">Cancelaci√≥n - Sin dev primas</option>
                          <option value="Cotizaci√≥n">Cotizaci√≥n</option>
                          <option value="Devoluci√≥n de Primas">Devoluci√≥n de Primas</option>
                          <option value="Emisi√≥n (nueva)">Emisi√≥n (nueva)</option>
                          <option value="Endoso 1 (alta coberturas-unidades)">Endoso 1 (alta coberturas-unidades)</option>
                          <option value="Endoso 2 - (baja coberturas-unidades)">Endoso 2 - (baja coberturas-unidades)</option>
                          <option value="Endoso 3 (sin modificaci√≥n de primas)">Endoso 3 (sin modificaci√≥n de primas)</option>
                          <option value="Otras">Otras</option>
                          <option value="Re-Expedici√≥n de Emisi√≥n Nueva">Re-Expedici√≥n de Emisi√≥n Nueva</option>
                          <option value="Re-Expedici√≥n de Renovaci√≥n">Re-Expedici√≥n de Renovaci√≥n</option>
                          <option value="Rehabilitar p√≥lizas/endosos">Rehabilitar p√≥lizas/endosos</option>
                          <option value="Renovaci√≥n">Renovaci√≥n</option>
                          <option value="Resello factura">Resello factura</option>
                          <option value="Seguimiento Serie en SISE">Seguimiento Serie en SISE</option>
                          <option value="Solicitud - BT normal">Solicitud - BT normal</option>
                          <option value="Solicitud - Clave AMIS">Solicitud - Clave AMIS</option>
                          <option value="Solicitud - Suma Asegurada">Solicitud - Suma Asegurada</option>

                      </select>
                    </div>
                  </div>
                </div>

                <!-- Paso 3: √Årea y tiempos de env√≠o/respuesta -->
                <div class="card-body">
                  <h2 class="h6 text-secondary fw-semibold mb-3">
                    <i class="bi bi-send-check me-2" aria-hidden="true"></i>√Årea
                    & Respuesta
                  </h2>
                  <div class="row g-3">
                    <div class="col-md-4">
                      <label class="form-label" for="f-area-env"
                        >Enviado al √Årea</label
                      >
                      <select
                        id="f-area-env"
                        class="form-select"
                        name="enviado_area"
                      >
                        <option value="" selected disabled>Selecciona</option>
                        <option value="AOF">AOF</option>
                        <option value="Caja Metepec">Caja Metepec</option>
                        <option value="Caja San Jer√≥nimo">
                          Caja San Jer√≥nimo
                        </option>
                        <option value="OTRS Suscripci√≥n Individual">
                          OTRS Suscripci√≥n Individual
                        </option>
                        <option value="OTRS Valores Convenidos">
                          OTRS Valores Convenidos
                        </option>
                        <option value="Plataforma CRM">Plataforma CRM</option>
                        <option value="Devoluciones (Milka)">
                          Devoluciones (Milka)
                        </option>
                        <option value="Control de agentes">
                          Control de agentes
                        </option>
                        <option value="Devoluciones OPL">
                          Devoluciones OPL
                        </option>
                        <option value="OTR tarifas">OTR tarifas</option>
                        <option value="Claudia V√°zquez (BP)">
                          Claudia V√°zquez (BP)
                        </option>
                        <option value="Cuentas Coorporativas (multianuales)">
                          Cuentas Coorporativas (multianuales)
                        </option>
                        <option value="Suscripci√≥n flotillas">
                          Suscripci√≥n flotillas
                        </option>
                      </select>
                    </div>

                    <div class="col-md-4">
                      <label class="form-label">Fecha/Hora env√≠o al √Årea</label>
                      <div class="input-group">
                        <input
                          type="date"
                          class="form-control"
                          name="fecha_envio_area"
                        />
                        <input
                          type="time"
                          class="form-control"
                          name="hora_envio_area"
                        />
                      </div>
                      <div
                        id="error-hora-envio-area"
                        class="form-text text-danger small"
                      ></div>
                    </div>

                    <div class="col-md-4">
                      <label class="form-label"
                        >Fecha/Hora respuesta del √Årea</label
                      >
                      <div class="input-group">
                        <input
                          type="date"
                          class="form-control"
                          name="fecha_resp_area"
                        />
                        <input
                          type="time"
                          class="form-control"
                          name="hora_resp_area"
                        />
                      </div>
                    </div>

                    <div class="col-12 mt-2">
                      <div class="d-flex flex-wrap gap-2">
                        <span
                          id="chip_t_envio_area"
                          class="badge text-bg-light border"
                          hidden
                        >
                          ‚è±Ô∏è Tiempo para enviar al √Årea:
                          <strong><span data-val="t_envio">‚Äî</span></strong>
                        </span>
                        <span
                          id="chip_t_resp_area"
                          class="badge text-bg-light border"
                          hidden
                        >
                          üì® Tiempo de respuesta del √Årea:
                          <strong><span data-val="t_resp">‚Äî</span></strong>
                        </span>
                      </div>
                    </div>
                  </div>
                </div>
              </section>

              <!-- Paso 3: Seguimiento -->
              <section
                class="card border-0 shadow-sm card-section mb-3 d-none"
                data-step="2"
              >
                <div class="card-body">
                  <h2 class="h6 text-secondary fw-semibold mb-3">
                    <i class="bi bi-flag me-2" aria-hidden="true"></i
                    >Seguimiento
                  </h2>
                  <div class="row g-3">
                    <div class="col-md-4">
                      <label class="form-label" for="f-estatus">Estatus</label>
                      <select id="f-estatus" class="form-select" name="estatus">
                        <option value="En curso">En curso</option>
                        <option value="Finalizado">Finalizado</option>
                        <option value="Enviado a √°rea">Enviado a √°rea</option>
                      </select>
                    </div>

                    <div class="col-md-4">
                      <label class="form-label" for="f-fseg"
                        >Fecha de Seguimiento</label
                      >
                      <input
                        id="f-fseg"
                        type="date"
                        class="form-control"
                        name="fecha_seguimiento"
                      />
                    </div>
                    <div class="col-md-4">
                      <label class="form-label" for="f-com">Comentarios</label>
                      <input
                        id="f-com"
                        class="form-control"
                        name="comentarios"
                        placeholder="Notas adicionales..."
                      />
                    </div>
                  </div>
                </div>
              </section>

              <!-- Paso 2: Env√≠o al agente -->
              <section
                class="card border-0 shadow-sm card-section mb-3 d-none"
                data-step="3"
              >
                <div class="card-body">
                  <h2 class="h6 text-secondary fw-semibold mb-3">
                    <i class="bi bi-share me-2" aria-hidden="true"></i>Env√≠o al
                    Agente
                  </h2>
                  <div class="row g-3">
                    <div class="col-md-6">
                      <label class="form-label"
                        >Fecha/Hora env√≠o al Agente</label
                      >
                      <div class="input-group">
                        <input
                          type="date"
                          class="form-control"
                          name="fecha_envio_agente"
                        />
                        <input
                          type="time"
                          class="form-control"
                          name="hora_envio_agente"
                          min="08:30"
                          max="18:30"
                          step="60"
                        />
                      </div>
                      <div
                        id="error-hora-envio-agente"
                        class="form-text text-danger small"
                      ></div>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label" for="f-asunto"
                        >Asunto en el correo</label
                      >
                      <input
                        id="f-asunto"
                        class="form-control"
                        name="asunto_correo"
                        placeholder="Ej. Renovaci√≥n p√≥liza flotilla Q3"
                      />
                    </div>
                  </div>
                </div>
              </section>

              <!-- Paso 4: Resumen -->
              <section
                class="card border-0 shadow-sm card-section mb-3 d-none"
                data-step="4"
              >
                <div class="card-body">
                  <h2 class="h6 text-secondary fw-semibold mb-3">
                    <i class="bi bi-clipboard-check me-2" aria-hidden="true"></i
                    >Revisi√≥n final
                  </h2>
                  <div id="resume" class="row g-3 small"><!-- JS --></div>
                </div>
              </section>
            </form>
          </div>

          <!-- ===================== RENOVACIONES (formulario espec√≠fico) ===================== -->
          <div
            class="tab-pane fade"
            id="pane-renov"
            role="tabpanel"
            aria-labelledby="tab-renov"
          >
            <form id="renewForm" class="card border-0 shadow-sm p-4" novalidate>
              <h2 class="h6 text-secondary fw-semibold mb-3">
                <i class="bi bi-shield-check me-2" aria-hidden="true"></i
                >Registro de Renovaci√≥n
              </h2>
              <div class="row g-3 mb-3">
                <div class="mb-3">
                  <label class="form-label" for="f-colaborador"
                    >Colaborador</label
                  >
                  <input
                    id="f-colaborador"
                    class="form-control"
                    name="colaborador"
                    placeholder="Tu nombre"
                    required
                    autocomplete="name"
                  />
                </div>
                <div class="col-md-4">
                  <label class="form-label" for="ren_fecha"
                    >Fecha de Renovaci√≥n</label
                  >
                  <input
                    type="datetime-local"
                    class="form-control"
                    id="ren_fecha"
                    name="ren_fecha"
                    readonly
                  />
                  <div class="form-text">
                    Se establece autom√°ticamente al capturar p√≥liza.
                  </div>
                </div>
                <div class="col-md-4">
                  <label class="form-label" for="ren_poliza_anterior"
                    >P√≥liza anterior</label
                  >
                  <input
                    class="form-control"
                    id="ren_poliza_anterior"
                    name="ren_poliza_anterior"
                    placeholder="0000000000"
                    required
                  />
                </div>
                <div class="col-md-4">
                  <label class="form-label" for="ren_poliza_nueva"
                    >P√≥liza renovada</label
                  >
                  <input
                    class="form-control"
                    id="ren_poliza_nueva"
                    name="ren_poliza_nueva"
                    placeholder="0000000000"
                    required
                  />
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label" for="ren_coment">Comentarios</label>
                <textarea
                  class="form-control"
                  id="ren_coment"
                  name="ren_coment"
                  rows="2"
                  placeholder="Notas de renovaci√≥n..."
                ></textarea>
              </div>
              <div class="text-end">
                <button
                  type="button"
                  class="btn btn-outline-primary"
                  id="renSave"
                >
                  <i class="bi bi-cloud-arrow-up me-1" aria-hidden="true"></i
                  >Guardar borrador
                </button>
                <button type="submit" class="btn btn-success">
                  <i class="bi bi-check2-circle me-1" aria-hidden="true"></i
                  >Registrar renovaci√≥n
                </button>
              </div>
            </form>
          </div>
        </main>
      </div>
    </div>

    <!-- Scripts -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
      defer
    ></script>
    <script src="js/app.js"></script>

    <!-- Wizard + l√≥gica de p√°gina -->

    <script data-init>
      document.addEventListener("DOMContentLoaded", () => {
        // ====== WIZARD (Registro general) ======
        const form = document.getElementById("wizardForm");
        const sections = form
          ? [...document.querySelectorAll("#pane-general section[data-step]")]
          : [];
        const steps = form
          ? [...document.querySelectorAll("#pane-general .stepper .step")]
          : [];
        const urlParams = new URLSearchParams(window.location.search);
        const editIdParam = urlParams.get("id");
        const usuarioStrGlobal = localStorage.getItem("hd_usuario");
        const esAdmin = window.hdIsAdmin === true;

        const agenteInput = document.getElementById("f-agente");
        const agenteInfo = document.getElementById("agente-info");
        const agenteError = document.getElementById("agente-error");

        const btnPrev = document.getElementById("btnPrev");
        const btnNext = document.getElementById("btnNext");
        const btnSubmit = document.getElementById("btnSubmit");
        const btnSave = document.getElementById("btnSave");
        const resume = document.getElementById("resume");
        let current = 1;

        // üîπ Cat√°logo temporal de agentes (mock)
        const CATALOGO_AGENTES = [
          { clave: "00203", nombre: "MOISES GARCIA YA&EZ" },
          { clave: "00381", nombre: "EDMUNDO PALOMINO MAGDALENO" },
          { clave: "00424", nombre: "AMADO MAURILIO ROJAS TARANGO" },
          { clave: "00522", nombre: "RAMON LARA PE&A" },
          { clave: "00525", nombre: "SALVADOR RAMIREZ VAZQUEZ" },
          { clave: "00648", nombre: "RAFAEL BUITRON FERNANDEZ" },
          { clave: "01275", nombre: "JUANA GONZALEZ VILLEGAS" },
          { clave: "03066", nombre: "MA. LOURDES MONROY AGUILAR" },
          { clave: "03177", nombre: "ELIA JUDITH ESPINOSA LEDESMA" },
          { clave: "03514", nombre: "RISKMANAGEMENT, AGENTE DE SEGUROS Y DE FIANZAS, S.A. DE C.V." },
          { clave: "03839", nombre: "FRANCISCO BALDERAS GERMAN" },
          { clave: "04350", nombre: "JOSEFINA HERNANDEZ ORTEGA" },
          { clave: "04583", nombre: "MISAEL CRUZ JIMENEZ" },
          { clave: "04652", nombre: "DEMETRIO KUSULAS ZERON" },
          { clave: "04782", nombre: "IRMA SOTO CLEMENTE" },
          { clave: "04965", nombre: "EDWARD LAWRENCE SHAW PHILIPS" },
          { clave: "04976", nombre: "MARIO PEREZ VILCHIS" },
          { clave: "05318", nombre: "LILIA COLIN MUNGUIA" },
          { clave: "05533", nombre: "ALEJANDRO LOPEZ ESTRADA" },
          { clave: "05642", nombre: "RAMON MARTINEZ VENEGAS" },
          { clave: "05699", nombre: "EDUARDO ADRIAN ESCAMILLA MONROY" },
          { clave: "05707", nombre: "MAURICIO OVIEDO JIMENEZ" },
          { clave: "05917", nombre: "JOSE GUADALUPE MOLINAR CABRAL" },
          { clave: "06138", nombre: "OLGA ERIKA SANCHEZ WARNKE" },
          { clave: "06305", nombre: "NORMA ANGELICA RIOS SANDOVAL" },
          { clave: "06674", nombre: "LUIS FELIPE GARCIA ZAVALA" },
          { clave: "06738", nombre: "MIGUEL ROBERTO HERNANDEZ PICHARDO" },
          { clave: "06916", nombre: "JEZABEL CARPIO RAMIREZ" },
          { clave: "06989", nombre: "MARIBEL RAMIREZ MEDINA" },
          { clave: "07317", nombre: "MEGA AUTOMOTRIZ, SA DE CV" },
          { clave: "07391", nombre: "AUTOFINANCIAMIENTO MEXICO, S.A. DE C.V." },
          { clave: "08108", nombre: "MARIA GUADALUPE HERNANDEZ GONZALEZ" },
          { clave: "08300", nombre: "MIGUEL TAFOLLA MALDONADO" },
          { clave: "08440", nombre: "HELITA MONTIEL RODRIGUEZ" },
          { clave: "08472", nombre: "ADRIAN MARTINEZ CUADROS" },
          { clave: "08532", nombre: "JUAN CARLOS MILLAN CORTES" },
          { clave: "08592", nombre: "MARIA DEL CARMEN CERON RODRIGUEZ" },
          { clave: "09005", nombre: "VENTAS MOSTRADOR OFICINA TOLUCA" },
          { clave: "13393", nombre: "MIGUEL ANGEL MENDOZA RIVERA" },
          { clave: "13462", nombre: "ELENA MAGDALENA AYALA PONTON" },
          { clave: "16064", nombre: "JOSE CORAZON TAPIA FERNANDEZ" },
          { clave: "16181", nombre: "LUIS FELIPE GARCIA RODRIGUEZ" },
          { clave: "16312", nombre: "CARLOS ROBERTO GALLEGOS LUNA" },
          { clave: "16550", nombre: "IGNACIO JOSE TERROBA TORTOLERO" },
          { clave: "17498", nombre: "LEON FELIPE BEDOYA MARTINEZ" },
          { clave: "17507", nombre: "JUAN MUCI&O SERRANO" },
          { clave: "17756", nombre: "FABIOLA TELLEZ ESCAMILLA" },
          { clave: "17955", nombre: "SILVIA NASTA VICTORIA" },
          { clave: "17960", nombre: "MA. OLGA BERNAL LAGUNAS" },
          { clave: "22246", nombre: "GILDARDO ZU&IGA MARIN" },
          { clave: "22714", nombre: "RUTILIO PI&A VELAZQUEZ" },
          { clave: "22955", nombre: "MIGUEL ANGEL CEBALLOS AYALA" },
          { clave: "23087", nombre: "JULIO CESAR ROJANO CEPEDA" },
          { clave: "23482", nombre: "CARLOS MANUEL VERONA IZAGUIRRE" },
          { clave: "23732", nombre: "ADMINISTRADORA DE SERV DE CALIDAD AGTE DE SEGUROS SA DE CV" },
          { clave: "24649", nombre: "NIDIA PATINO LONA" },
          { clave: "24869", nombre: "JUAN JOSE BARREIRO PAEZ" },
          { clave: "25202", nombre: "JULIAN EYMAR VENCES ALVAREZ" },
          { clave: "30391", nombre: "PABLO LOPEZ ROSALES" },
          { clave: "30596", nombre: "LILIANA JOSEFINA SANCHEZ SANCHEZ" },
          { clave: "30982", nombre: "IRAN DIAZ ALONSO" },
          { clave: "31192", nombre: "LETICIA HORTENSIA TALAVERA JUAREZ" },
          { clave: "31914", nombre: "MARISOL PAREDEZ CANTAREY" },
          { clave: "35109", nombre: "NORMA PE&A ALMADA" },
          { clave: "35920", nombre: "ANTONIO FERNANDEZ DE JESUS" },
          { clave: "40496", nombre: "PF TOLLOCAN, S.A. DE C.V." },
          { clave: "40497", nombre: "PF TOLLOCAN, S.A. DE C.V." },
          { clave: "40498", nombre: "PF TOLLOCAN, S.A. DE C.V." },
          { clave: "42457", nombre: "METEPEC MOTORS S.A. DE C.V." },
          { clave: "43338", nombre: "VEHICULOS Y SERVICIOS SATELITE,SA DE CV" },
          { clave: "43339", nombre: "VEHICULOS Y SERVICIOS SATELITE,SA DE CV" },
          { clave: "43982", nombre: "SAN MATEO MOTORS SA DE CV" },
          { clave: "43984", nombre: "MEGA AUTOMOTRIZ, SA DE CV" },
          { clave: "44071", nombre: "SANCHEZ AUTOMOTRIZ SA DE CV" },
          { clave: "44432", nombre: "INCOSOL SA DE CV" },
          { clave: "50255", nombre: "GERSON BENJAMIN GONZALEZ ZU&IGA" },
          { clave: "50474", nombre: "ADMINISTRADORA DE SERV DE CALIDAD AGTE DE SEGUROS SA DE CV" },
          { clave: "50726", nombre: "YATZILTH PALACIOS GOICOCHEA" },
          { clave: "52038", nombre: "MARIO GABINO ESTRADA FLORES" },
          { clave: "55454", nombre: "SILVIA NASTA VICTORIA" },
          { clave: "55571", nombre: "BERNARDO ANGULO GONZALEZ" },
          { clave: "56127", nombre: "JOSE URIEL CORZA URIBE" },
          { clave: "56128", nombre: "CECILIO ALFONSO SALAZAR CEBALLOS" },
          { clave: "56250", nombre: "MANUEL RABINDRANATH ESCALERA MERAZ" },
          { clave: "57841", nombre: "MOISES GARCIA YA&EZ" },
          { clave: "58560", nombre: "GRUPO AFSE DE MEXICO AGENTE DE SEGUROS Y DE FIANZAS SA DE CV" },
          { clave: "58775", nombre: "LUCINA GARCIA GONZALEZ" },
          { clave: "59323", nombre: "SALVADOR RAMIREZ VAZQUEZ" },
          { clave: "59596", nombre: "GRUPO RCM AGENTE DE SEGUROS Y DE FIANZAS, S.A. DE C.V." },
          { clave: "59664", nombre: "JUAN CARLOS ROSSANO SERRANO" },
          { clave: "60428", nombre: "ALFREDO ALEJO BECERRIL" },
          { clave: "61117", nombre: "ALFREDO SORDO AGUILAR" },
          { clave: "61194", nombre: "NOEMI CARDENAS ESPINOZA" },
          { clave: "61222", nombre: "SALVADOR LOPEZ JIMENEZ" },
          { clave: "61357", nombre: "CESAR SANCHEZ SANCHEZ DE TAGLE" },
          { clave: "61384", nombre: "MARIA LEISLY MARTINEZ LOPEZ" },
          { clave: "61419", nombre: "FRANCISCA ORTIZ MENDOZA" },
          { clave: "61485", nombre: "ALFONSO ERICK SANCHEZ ESCARCEGA" },
          { clave: "61545", nombre: "EFREN ESTRADA VELAZQUEZ" },
          { clave: "61549", nombre: "EDGAR ALEJANDRO AGUILAR NAVARRETE" },
          { clave: "61550", nombre: "GUADALUPE ZOE SOLEDAD GOMEZ RAMIREZ" },
          { clave: "61605", nombre: "SALVADOR LOPEZ JIMENEZ" },
          { clave: "61606", nombre: "FRANCISCA ORTIZ MENDOZA" },
          { clave: "61696", nombre: "JESUS RUBEN RIOS ROBLEDO" },
          { clave: "61801", nombre: "AIME VALDES ECHEVERRIA" },
          { clave: "61927", nombre: "YOSELIN PASCACIO NUNEZ" },
          { clave: "61948", nombre: "GUADALUPE ZOE SOLEDAD GOMEZ RAMIREZ" },
          { clave: "62017", nombre: "TANIA CRISTINA JIMENEZ RUIZ" },
          { clave: "62032", nombre: "MARIA DEL CONSUELO ZU&IGA ZATARAIN" },
          { clave: "62302", nombre: "FERNANDO MACARIO ROMERO" },
          { clave: "62379", nombre: "TANIA MAYA LOPEZ" },
          { clave: "62471", nombre: "RAFAEL MAX RAMOS CALDERON" },
          { clave: "62837", nombre: "GUILLERMO MENDOZA NU&EZ" },
          { clave: "63825", nombre: "VICTOR HUGO PIMENTEL FLORES" },
          { clave: "64093", nombre: "MARCO ANTONIO CABALLERO MATEOS" },
          { clave: "64178", nombre: "GERMAN ZOE NAVARRO LOPEZ" },
          { clave: "64293", nombre: "JUAN ALBERTO ORDO&EZ LARA" },
          { clave: "64494", nombre: "MARIA JUANA FERMIN CONTRERAS" },
          { clave: "64510", nombre: "TERESA AVELAR LOPEZ" },
          { clave: "64546", nombre: "JOSE LUIS MEDINA GONZALEZ" },
          { clave: "64578", nombre: "IVAN GARCIA GUADARRAMA" },
          { clave: "64592", nombre: "ESTHELA REYES HERNANDEZ" },
          { clave: "64598", nombre: "BEATRIZ SANTANA BECERRIL" },
          { clave: "64660", nombre: "LUCRECIA LOZANO CRUZ" },
          { clave: "64871", nombre: "EFREN LINARES ESTRADA" },
          { clave: "64899", nombre: "MARCO ANTONIO ZAMUDIO LOPEZ" },
          { clave: "65068", nombre: "CLAUDIA NATALIA NU&EZ ESPARZA" },
          { clave: "65279", nombre: "FRANCO AGUILAR NAVA" },
          { clave: "65336", nombre: "LUIS MAURICIO TELLEZ ESCAMILLA" },
          { clave: "65434", nombre: "RICARDO ISRAEL RODRIGUEZ ARTEAGA" },
          { clave: "65436", nombre: "GLORIA IVONNE ESPARZA DURAN" },
          { clave: "65444", nombre: "JOSUE CURIEL NERI" },
          { clave: "65534", nombre: "JOSE LUIS MARTINEZ ORDO&EZ" },
          { clave: "65543", nombre: "CECILIA VILCHIS PORCAYO" },
          { clave: "66053", nombre: "KAREN CARMIN HARO PEREZ" },
          { clave: "66848", nombre: "FABIOLA RAMIREZ BERMUDEZ" },
          { clave: "66903", nombre: "JOSE GERARDO SALDA&A VALDES" },
          { clave: "66962", nombre: "SBHEIDY ESCAMILLA DORANTES" },
          { clave: "67066", nombre: "KAREN IVETTE PLATA REYES" },
          { clave: "67161", nombre: "JOSE LUIS GUTIERREZ OLGUIN" },
          { clave: "67322", nombre: "RAMON ESTEBAN MENDEZ CASTANEDA" },
          { clave: "67500", nombre: "EDGAR ALEJANDRO AGUILAR NAVARRETE" },
          { clave: "67508", nombre: "KARLA IVONNE MACEDO CUENCA" },
          { clave: "67530", nombre: "PERLA JANNET RANGEL JIMENEZ" },
          { clave: "67549", nombre: "MARTIN GONZALEZ NAVA" },
          { clave: "67979", nombre: "GUSTAVO ALBERTO ROJAS ESPINOSA" },
          { clave: "68163", nombre: "KARINA PEREZ PEDRAL" },
          { clave: "68292", nombre: "MUSOL MONROY CASTRO" },
          { clave: "68543", nombre: "MAURICIO GARZA GARCIA" },
          { clave: "68644", nombre: "ROBERTO ESPINOZA MONTES DE OCA" },
          { clave: "69064", nombre: "Andrea Melissa Rincon Trejo" },
          { clave: "69288", nombre: "ANAID LARA MENDOZA" },
          { clave: "70180", nombre: "EDUARDO KICK CERVANTES" },
          { clave: "70219", nombre: "JUAN GARCIA GARCIA" },
          { clave: "70237", nombre: "AON RISK SOLUTIONS,AGENTE DE SEGUROS Y DE FIANZAS,S.A.DE C.V" },
          { clave: "71763", nombre: "LILIANA JOSEFINA SANCHEZ SANCHEZ" },
          { clave: "71827", nombre: "SERGIO ARRIETA ALDACO" },
          { clave: "72216", nombre: "THELMA YOLANDA ESTRADA HIDALGO" },
          { clave: "72844", nombre: "AON RISK SOLUTIONS,AGENTE DE SEGUROS Y DE FIANZAS,S.A.DE C.V" },
          { clave: "73943", nombre: "AURELIANO SANCHEZ CUEVAS" },
          { clave: "74564", nombre: "JAVIER ESPINOZA DOMINGUEZ" },
          { clave: "74609", nombre: "HECTOR CARLOS GARZA GUERRA" },
          { clave: "74894", nombre: "YAZMIN RETANA MORENO" },
          { clave: "74978", nombre: "LUIS EDUARDO CHAPARRO SANCHEZ" },
          { clave: "75066", nombre: "ANA LILIA SALDA&A SANCHEZ" },
          { clave: "75109", nombre: "NADIA CAROLYNE BAUTISTA BARAJAS" },
          { clave: "75650", nombre: "JORGE MORENO CRIVELLI" },
          { clave: "75828", nombre: "SMART RESOLVIENDO TU VIDA, AGENTE DE SEGUROS S.A. DE C.V." },
          { clave: "75919", nombre: "RICARDO MORALES MARTINEZ" },
          { clave: "76497", nombre: "JUAN EMILIO RAMOS CALDERON" },
          { clave: "77013", nombre: "FERNANDO GARCIA ESTRADA" },
          { clave: "77610", nombre: "CYNTIA TERESA ZALDIVAR RADILLA" },
          { clave: "77871", nombre: "GEORGINA ORTEGA ORTIZ" },
          { clave: "77935", nombre: "MERCEDES GOMEZ FLORES" },
          { clave: "77965", nombre: "RAMON LARA PE&A" },
          { clave: "77966", nombre: "RAMON LARA PE&A" },
          { clave: "77967", nombre: "RAMON LARA PE&A" },
          { clave: "78379", nombre: "LILIANA MARIA GUTIERREZ GONZALEZ" },
          { clave: "78502", nombre: "JUAN MANUEL LINARES CORTES" },
          { clave: "78651", nombre: "LUCERO FLORES ORTIZ" },
          { clave: "78901", nombre: "FRANCISCO JAVIER NU&EZ GUTIERREZ" },
          { clave: "79045", nombre: "GLADYS ZULMIRA APONTE MENDEZ" },
          { clave: "79078", nombre: "GABRIELA SIERRA MARTINEZ" },
          { clave: "79271", nombre: "RAFAEL REBOLLAR FERNANDEZ" },
          { clave: "79374", nombre: "ARNULFO ALVA RUIZ" },
          { clave: "79669", nombre: "ALEJANDRO BENITEZ GARCIA" },
          { clave: "79941", nombre: "ERIK BERNARDO CERON FLORES" },
          { clave: "80110", nombre: "OSCAR AARON MARTINEZ GARCIA" },
          { clave: "80947", nombre: "LILIANA RUBIO CARBAJAL" },
          { clave: "81083", nombre: "ERIK BERNARDO CERON FLORES" },
          { clave: "81097", nombre: "RUBEN CRUZ MARTINEZ" },
          { clave: "82220", nombre: "ERIK BERNARDO CERON FLORES" },
          { clave: "82290", nombre: "RAFAEL REBOLLAR FERNANDEZ" },
          { clave: "82440", nombre: "GRUPO RCM AGENTE DE SEGUROS Y DE FIANZAS, S.A. DE C.V." },
          { clave: "82736", nombre: "RAFAEL REBOLLAR FERNANDEZ" },
          { clave: "82809", nombre: "DANIELA ROBLES CARPIO" },
          { clave: "82821", nombre: "MA. LOURDES MONROY AGUILAR" },
          { clave: "83053", nombre: "IINSURED BROKERS,AGENTE DE SEGUROS Y DE FIANZAS,S.A DE C.V" },
          { clave: "83591", nombre: "OMAR GARCIA GUADARRAMA" },
          { clave: "83873", nombre: "JOSE URIEL CORZA URIBE" },
          { clave: "84558", nombre: "IRVING ESQUIVEL ONTIVEROS" },
          { clave: "85512", nombre: "BERENICE SOLIS VAZQUEZ" },
          { clave: "85635", nombre: "ABDEL PATRICIA DE LA TORRE PEREZ" },
          { clave: "86091", nombre: "KOI, AGENTE DE SEGUROS Y DE FIANZAS, S.A. DE C.V." },
          { clave: "86534", nombre: "MONICA AMELIA GARCIA MARTINEZ" },
          { clave: "86801", nombre: "ARTURO ANGEL SAINZ LOPEZ" },
          { clave: "86918", nombre: "EDUARDO KICK CERVANTES" },
          { clave: "86948", nombre: "MARSH MEXICO, AGENTE DE SEGUROS Y DE FIANZAS, SA DE CV" },
          { clave: "87260", nombre: "TANIA MAYA LOPEZ" },
          { clave: "87354", nombre: "ANGEL RODRIGO REYES LUNA" },
          { clave: "87622", nombre: "JOEL JACINTO DELGADO" },
          { clave: "87781", nombre: "FABRICIA LEON LEON" },
          { clave: "87941", nombre: "JUAN CARLOS BOBADILLA DIAZ" },
          { clave: "87942", nombre: "RENE OMAR TORTI RIOS" },
          { clave: "87950", nombre: "JOSE MARIO LOPEZ ITURBIDE" },
          { clave: "88178", nombre: "ARTURO ISAAC RAMIREZ VALDESPINO" },
          { clave: "88189", nombre: "HYLANT MEXICO AGTE DE SEG Y DE FZAS SA D" },
          { clave: "88199", nombre: "HYLANT MEXICO AGTE DE SEG Y DE FZAS SA D" },
          { clave: "88200", nombre: "HYLANT MEXICO AGTE DE SEG Y DE FZAS SA D" },
          { clave: "88201", nombre: "HYLANT MEXICO AGTE DE SEG Y DE FZAS SA D" },
          { clave: "88203", nombre: "MAURICIO ORTIZ GONZALEZ" },
          { clave: "88340", nombre: "MARCO AURELIO CEBALLOS CORONA" },
          { clave: "88362", nombre: "INBROS, AGENTE DE SEGUROS Y DE FIANZAS S.A. DE C.V." },
          { clave: "88494", nombre: "DONATO EMMANUEL SANTOS MATEO" },
          { clave: "88591", nombre: "JUAN RAUL TAPIA GRISI" },
          { clave: "88832", nombre: "VER NICA JACKELINE GARCIA SOLORIO" },
          { clave: "88876", nombre: "EDER ANDREY LUQUES GAMEZ" },
          { clave: "88877", nombre: "ERICKA SANDOVAL ALVAREZ" },
          { clave: "89050", nombre: "IRENE DE JESUS MORALES SALAZAR" },
          { clave: "89055", nombre: "NORMA ANGELICA RIOS SANDOVAL" },
          { clave: "89056", nombre: "NORMA ANGELICA RIOS SANDOVAL" },
          { clave: "89395", nombre: "ALICIA MONZERRAT MALANCO SIERRA" },
          { clave: "89504", nombre: "ALY CORANY ABDALLAH" },
          { clave: "89612", nombre: "QUITZIA ZEPEDA DIAZ" },
          { clave: "89738", nombre: "MIGUEL ANGEL GOMEZ CASTILLO" },
          { clave: "90218", nombre: "QUALITAS COMPA&IA DE SEGUROS S.A. DE C.V." },
          { clave: "90265", nombre: "QUALITAS COMPA&IA DE SEGUROS S.A. DE C.V." },
          { clave: "90392", nombre: "QUALITAS COMPA&IA DE SEGUROS S.A. DE C.V." },
          { clave: "90490", nombre: "VENTAS MOSTRADOR OFICINA TOLUCA" },
          { clave: "96147", nombre: "QUALITAS COMPA&IA DE SEGUROS S.A. DE C.V." },
          { clave: "96282", nombre: "QUALITAS COMPA&IA DE SEGUROS S.A. DE C.V." },
          { clave: "90392", nombre: "QUALITAS COMPA&IA DE SEGUROS S.A. DE C.V" },
          { clave: "68702", nombre: "NABOR FRANCISCO GONZ√ÅLEZ AGUILAR" },
          { clave: "27855", nombre: "MONICA LOPEZ SORIANO" },
          { clave: "28535", nombre: "SAMUEL RUIZ SANCHEZ" },
          { clave: "28586", nombre: "Gerardo Lobo Trevi√±o" },
          { clave: "28583", nombre: "Christian Hern√°ndez Valdes" }
        ];

        
        function buscarAgentePorClave(clave) {
          if (!clave) return null;
          return CATALOGO_AGENTES.find((a) => a.clave === clave) || null;
        }

        function limpiarErroresAgente() {
          if (agenteInput) agenteInput.classList.remove("is-invalid");
          if (agenteError) agenteError.textContent = "";
        }

        // ===== Autollenar colaborador + fecha/hora en NUEVOS registros =====

        if (!editIdParam && form) {
          const colabInput = document.getElementById("f-colaborador");
          const fechaInput = document.getElementById("f-fecha");
          const horaRecInput = document.getElementById("f-hrec");

          const fechaEnvAgenteInput = document.querySelector(
            'input[name="fecha_envio_agente"]'
          );
          const horaEnvAgenteInput = document.querySelector(
            'input[name="hora_envio_agente"]'
          );

          // Colaborador desde el login
          if (usuarioStrGlobal && colabInput) {
            try {
              const u = JSON.parse(usuarioStrGlobal);
              const nombre = u.nombre || u.username || "";
              if (!colabInput.value && nombre) {
                colabInput.value = nombre;
              }
              colabInput.readOnly = true;
              colabInput.classList.add("bg-light", "text-muted");
            } catch (e) {
              console.error("No se pudo parsear hd_usuario", e);
            }
          }

          // Fecha y hora de recepci√≥n por defecto = ahora
          const now = new Date();
          const pad = (n) => String(n).padStart(2, "0");
          const yyyy = now.getFullYear();
          const mm = pad(now.getMonth() + 1);
          const dd = pad(now.getDate());
          const hh = pad(now.getHours());
          const mi = pad(now.getMinutes());

          const fechaHoy = `${yyyy}-${mm}-${dd}`;
          const horaAhora = `${hh}:${mi}`;

          if (fechaInput && !fechaInput.value) fechaInput.value = fechaHoy;
          if (horaRecInput && !horaRecInput.value)
            horaRecInput.value = horaAhora;

          // En NUEVOS registros no se captura fecha de seguimiento
          const fsegNuevo = form.elements["fecha_seguimiento"];
          if (fsegNuevo) {
            fsegNuevo.value = ""; // sin valor
            fsegNuevo.readOnly = true;
            fsegNuevo.disabled = true;
            fsegNuevo.classList.add("bg-light", "text-muted");
          }
        }

        // ===== Eventos de agente clave =====
        if (agenteInput) {
          agenteInput.addEventListener("input", (e) => {
            let v = e.target.value || "";
            v = v.replace(/\D/g, "");
            if (v.length > 5) v = v.slice(0, 5);
            e.target.value = v;

            limpiarErroresAgente();
            if (v.length < 5 && agenteInfo) {
              agenteInfo.textContent = "";
            }
          });

          agenteInput.addEventListener("blur", () => {
            const v = agenteInput.value.trim();
            if (!v) return;

            if (!/^\d{5}$/.test(v)) {
              agenteInput.classList.add("is-invalid");
              if (agenteError) {
                agenteError.textContent =
                  "La clave debe tener exactamente 5 d√≠gitos.";
              }
              if (agenteInfo) agenteInfo.textContent = "";
              return;
            }

            const agente = buscarAgentePorClave(v);
            if (!agente) {
              agenteInput.classList.add("is-invalid");
              if (agenteError) {
                agenteError.textContent =
                  "No se encontr√≥ un agente con esa clave.";
              }
              if (agenteInfo) agenteInfo.textContent = "";
              return;
            }

            limpiarErroresAgente();
            if (agenteInfo) {
              agenteInfo.textContent = `Agente: ${agente.nombre}`;
            }
          });
        }

        // ===== Helpers de wizard =====
        function lastStep() {
          return sections.length ? +sections.at(-1).dataset.step : 1;
        }

        function isStepVisible(n) {
          if (!form) return false;
          // Por ahora TODOS los pasos del 1 al √∫ltimo son visibles
          return true;
        }

        function nextVisibleStep(n) {
          let t = n + 1;
          const last = lastStep();
          while (t <= last && !isStepVisible(t)) t++;
          return Math.min(t, last);
        }

        function prevVisibleStep(n) {
          let t = n - 1;
          while (t >= 1 && !isStepVisible(t)) t--;
          return Math.max(t, 1);
        }

        function focusFirstInput(stepEl) {
          const el =
            stepEl && stepEl.querySelector("input, select, textarea, button");
          if (el) el.focus({ preventScroll: true });
        }

        function showStep(n) {
          if (!form) return;
          const last = lastStep();
          current = Math.max(1, Math.min(n, last));
          sections.forEach((s) =>
            s.classList.toggle("d-none", +s.dataset.step !== current)
          );
          steps.forEach((s) => {
            s.classList.toggle("active", +s.dataset.step === current);
            s.classList.toggle("done", +s.dataset.step < current);
          });
          if (btnPrev) btnPrev.disabled = current === 1;
          if (btnNext) btnNext.classList.toggle("d-none", current === last);
          if (btnSubmit) btnSubmit.classList.toggle("d-none", current !== last);
          if (current === last) buildResume();
          focusFirstInput(sections.find((s) => +s.dataset.step === current));
          window.scrollTo({ top: 0, behavior: "smooth" });
        }

        function buildResume() {
          if (!form || !resume) return;
          const data = Object.fromEntries(new FormData(form));
          const pretty = {
            colaborador: "Colaborador",
            fecha: "Fecha",
            hora_recepcion: "Hora de recepci√≥n",
            agente_clave: "Agente clave",
            forma_solicitud: "Forma de solicitud",
            tipo_solicitud: "Tipo de solicitud",
            enviado_area: "Enviado al √°rea",
            fecha_envio_area: "Fecha env√≠o √°rea",
            hora_envio_area: "Hora env√≠o √°rea",
            fecha_resp_area: "Fecha respuesta √°rea",
            hora_resp_area: "Hora respuesta √°rea",
            fecha_envio_agente: "Fecha env√≠o agente",
            hora_envio_agente: "Hora env√≠o agente",
            estatus: "Estatus",
            fecha_seguimiento: "Fecha seguimiento",
            comentarios: "Comentarios",
          };
          resume.innerHTML = Object.entries(pretty)
            .map(([key, label]) => {
              const val = (data[key] ?? "") || "‚Äî";
              return `<div class="col-md-4"><div class="border rounded-3 p-3 bg-light mb-2"><div class="text-muted">${label}</div><div class="fw-semibold">${val}</div></div></div>`;
            })
            .join("");
        }

        function validateStep() {
          if (!form) return false;
          let ok = true;
          const visible = sections.find((s) => +s.dataset.step === current);
          visible &&
            [...visible.querySelectorAll("[required]")].forEach((inp) => {
              if (inp.disabled) return; // no validar deshabilitados
              const name = inp.name;

              if (!inp.value) {
                inp.classList.add("is-invalid");
                ok = false;
              } else {
                inp.classList.remove("is-invalid");
              }

              if (name === "agente_clave" && inp.value) {
                const v = inp.value.trim();
                if (!/^\d{5}$/.test(v)) {
                  inp.classList.add("is-invalid");
                  ok = false;
                  if (agenteInfo) {
                    agenteInfo.textContent =
                      "La clave del agente debe tener exactamente 5 d√≠gitos.";
                  }
                }
              }

              inp.addEventListener(
                "input",
                () => inp.classList.remove("is-invalid"),
                { once: true }
              );
            });
          return ok;
        }

        // Debounce
        function debounce(fn, ms = 400) {
          let t;
          return (...args) => {
            clearTimeout(t);
            t = setTimeout(() => fn(...args), ms);
          };
        }

        function saveDraft(showToast) {
          if (!form) return;
          const data = Object.fromEntries(new FormData(form));
          localStorage.setItem(
            "helpdesk_draft",
            JSON.stringify({ current, data, when: Date.now() })
          );
          if (showToast && window.bootstrap) {
            const t = document.createElement("div");
            t.className =
              "toast align-items-center text-bg-success border-0 position-fixed bottom-0 end-0 m-3";
            t.role = "alert";
            t.innerHTML = `<div class="d-flex"><div class="toast-body">Borrador guardado</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
            document.body.appendChild(t);
            const toast = new bootstrap.Toast(t);
            toast.show();
            t.addEventListener("hidden.bs.toast", () => t.remove());
          }
        }
        const saveDraftDebounced = debounce(() => saveDraft(false), 500);

        // ====== C√°lculo de tiempos ======
        function parseDT(d, t) {
          if (!d || !t) return null;
          return new Date(`${d}T${t}`);
        }

        function humanDiff(ms) {
          if (!Number.isFinite(ms)) return "‚Äî";
          const min = Math.round(ms / 60000);
          const h = Math.floor(min / 60),
            m = min % 60;
          if (h <= 0) return `${m} min`;
          if (m === 0) return `${h} h`;
          return `${h} h ${m} min`;
        }

        function computeDurations() {
          if (!form) return;
          const dRec = form.fecha?.value,
            tRec = form.hora_recepcion?.value;
          const dEnvA = form.fecha_envio_area?.value,
            tEnvA = form.hora_envio_area?.value;
          const dResp = form.fecha_resp_area?.value,
            tResp = form.hora_resp_area?.value;

          const dtRec = parseDT(dRec, tRec);
          const dtEnvA = parseDT(dEnvA, tEnvA);
          const dtResp = parseDT(dResp, tResp);

          const chipEnv = document.getElementById("chip_t_envio_area");
          const chipEnvVal = chipEnv?.querySelector('[data-val="t_envio"]');
          if (dtRec && dtEnvA && chipEnv && chipEnvVal) {
            chipEnv.hidden = false;
            chipEnvVal.textContent = humanDiff(dtEnvA - dtRec);
          } else if (chipEnv) {
            chipEnv.hidden = true;
          }

          const chipResp = document.getElementById("chip_t_resp_area");
          const chipRespVal = chipResp?.querySelector('[data-val="t_resp"]');
          if (dtEnvA && dtResp && chipResp && chipRespVal) {
            chipResp.hidden = false;
            chipRespVal.textContent = humanDiff(dtResp - dtEnvA);
          } else if (chipResp) {
            chipResp.hidden = true;
          }
        }
        function validateHoraNegocio(
          fechaInput,
          horaInput,
          errorEl,
          labelCampo
        ) {
          if (!fechaInput || !horaInput) return true;

          const fecha = fechaInput.value;
          const hora = horaInput.value;

          // Si no hay nada capturado, no marcamos error (es opcional)
          if (!fecha && !hora) {
            if (errorEl) errorEl.textContent = "";
            horaInput.classList.remove("is-invalid");
            return true;
          }

          // Si llenan uno s√≠ y otro no, marcamos error
          if (!fecha || !hora) {
            if (errorEl)
              errorEl.textContent = `Completa ${labelCampo} (fecha y hora).`;
            horaInput.classList.add("is-invalid");
            return false;
          }

          const dt = new Date(`${fecha}T${hora}`);
          if (Number.isNaN(dt.getTime())) {
            if (errorEl) errorEl.textContent = "Fecha/hora no v√°lida.";
            horaInput.classList.add("is-invalid");
            return false;
          }

          const day = dt.getDay(); // 0=dom, 6=s√°b
          const minutes = dt.getHours() * 60 + dt.getMinutes();
          const start = 8 * 60 + 30; // 08:30
          const end = 18 * 60 + 30; // 18:30

          if (day === 0 || day === 6 || minutes < start || minutes > end) {
            if (errorEl) {
              errorEl.textContent = `${labelCampo} debe ser de lunes a viernes, entre 08:30 y 18:30.`;
            }
            horaInput.classList.add("is-invalid");
            return false;
          }

          // OK
          if (errorEl) errorEl.textContent = "";
          horaInput.classList.remove("is-invalid");
          return true;
        }
        // ====== MOCK "BASE DE DATOS" DE ACTIVIDADES ======
        const STORAGE_KEY_ACTIVIDADES = "hd_actividades";

        function loadStoredActivities() {
          try {
            return JSON.parse(
              localStorage.getItem(STORAGE_KEY_ACTIVIDADES) || "[]"
            );
          } catch (e) {
            console.error("No se pudo leer hd_actividades", e);
            return [];
          }
        }

        function saveStoredActivities(lista) {
          try {
            localStorage.setItem(
              STORAGE_KEY_ACTIVIDADES,
              JSON.stringify(lista)
            );
          } catch (e) {
            console.error("No se pudo guardar hd_actividades", e);
          }
        }

        function getNextActivityId(lista) {
          if (!Array.isArray(lista) || !lista.length) return 1;
          const maxId = lista.reduce((max, a) => {
            const idNum =
              typeof a.id === "number" ? a.id : parseInt(a.id, 10) || 0;
            return Math.max(max, idNum);
          }, 0);
          return maxId + 1;
        }

        function slugifyColaborador(str) {
          return (str || "")
            .toUpperCase()
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "")
            .replace(/[^A-Z0-9]/g, "")
            .slice(1, 5);
        }

        function buildActividadFromForm(data) {
          // ===== Usuario logueado =====
          let usuarioLogin = null;
          let usuarioNombre = null;
          let usuarioRol = null;

          if (usuarioStrGlobal) {
            try {
              const u = JSON.parse(usuarioStrGlobal);
              usuarioLogin = u.username || null;
              usuarioNombre = u.nombre || null;
              usuarioRol = u.rol || null;
            } catch (e) {
              console.error("No se pudo leer hd_usuario", e);
            }
          }

          // ===== Historial de seguimientos =====
          let seguimientos = Array.isArray(editingActividad?.seguimientos)
            ? [...editingActividad.seguimientos]
            : [];

          // Si hay comentario nuevo, lo agregamos al historial
          if ((data.comentarios || "").trim()) {
            seguimientos.push({
              fechaISO: new Date().toISOString(),
              comentario: data.comentarios.trim(),
              usuario: usuarioLogin || usuarioNombre || null,
            });
          }

          // ===== Merge de datos cuando estamos editando =====
          // Campos que se ‚Äúpierden‚Äù porque est√°n disabled en el form
          if (editingActividad) {
            // Recepci√≥n
            data.fecha =
              data.fecha ||
              editingActividad.fechaRecepcion ||
              (editingActividad.fechaRegistro || "").slice(0, 10);
            data.hora_recepcion =
              data.hora_recepcion ||
              editingActividad.horaRecepcion ||
              editingActividad.horaRegistro;

            // Env√≠o al √°rea
            data.enviado_area =
              data.enviado_area || editingActividad.areaDestino;
            data.fecha_envio_area =
              data.fecha_envio_area || editingActividad.fechaEnvioArea;
            data.hora_envio_area =
              data.hora_envio_area || editingActividad.horaEnvioArea;

            // Respuesta del √°rea
            data.fecha_resp_area =
              data.fecha_resp_area || editingActividad.fechaRespArea;
            data.hora_resp_area =
              data.hora_resp_area || editingActividad.horaRespArea;

            // Env√≠o al agente
            data.fecha_envio_agente =
              data.fecha_envio_agente || editingActividad.fechaEnvioAgente;
            data.hora_envio_agente =
              data.hora_envio_agente || editingActividad.horaEnvioAgente;

            // Seguimiento
            data.fecha_seguimiento =
              data.fecha_seguimiento || editingActividad.fechaSeguimiento;
          }

          // ===== C√°lculo de tiempos =====

          // Inicio del proceso = recepci√≥n
          const fechaRegistro =
            data.fecha || new Date().toISOString().slice(0, 10);
          const horaRegistro = data.hora_recepcion || null;
          const dtInicio = parseDT(fechaRegistro, horaRegistro);

          // Fin del proceso = preferimos env√≠o al agente
          let dtFinProceso = null;
          if (data.fecha_envio_agente && data.hora_envio_agente) {
            dtFinProceso = parseDT(
              data.fecha_envio_agente,
              data.hora_envio_agente
            );
          } else if (data.fecha_resp_area && data.hora_resp_area) {
            dtFinProceso = parseDT(data.fecha_resp_area, data.hora_resp_area);
          } else if (data.fecha_envio_area && data.hora_envio_area) {
            dtFinProceso = parseDT(data.fecha_envio_area, data.hora_envio_area);
          }

          // Tiempo total del proceso
          let tiempoTotalMin = null;
          if (dtInicio && dtFinProceso && dtFinProceso > dtInicio) {
            tiempoTotalMin = Math.round((dtFinProceso - dtInicio) / 60000);
          }

          // Tiempo que se tard√≥ el √°rea (env√≠o √°rea -> respuesta √°rea)
          let tiempoAreaMin = null;
          if (
            data.fecha_envio_area &&
            data.hora_envio_area &&
            data.fecha_resp_area &&
            data.hora_resp_area
          ) {
            const dtEnvioArea = parseDT(
              data.fecha_envio_area,
              data.hora_envio_area
            );
            const dtRespArea = parseDT(
              data.fecha_resp_area,
              data.hora_resp_area
            );
            if (dtEnvioArea && dtRespArea && dtRespArea > dtEnvioArea) {
              tiempoAreaMin = Math.round((dtRespArea - dtEnvioArea) / 60000);
            }
          }

          // ===== Estatus =====
          let estatus;
          if (data.estatus) {
            // Si viene del form (cuando no est√° disabled)
            estatus = data.estatus;
          } else if (editingActividad && editingActividad.estatus) {
            // En edici√≥n, respetamos el estatus que ya ten√≠a
            estatus = editingActividad.estatus;
          } else if (data.fecha_envio_agente) {
            estatus = "Finalizado";
          } else if (data.enviado_area) {
            estatus = "Enviado a √°rea";
          } else {
            estatus = "En curso";
          }

          // ===== Colaborador / folio =====
          const colaboradorForm = data.colaborador || null;
          const colaboradorFinal =
            colaboradorForm || usuarioNombre || usuarioLogin || null;

          const fechaKey = (fechaRegistro || "").replace(/-/g, "");
          const horaKey = (horaRegistro || "").replace(":", "");
          const colKey = slugifyColaborador(colaboradorFinal || usuarioLogin);

          const folio =
            editingActividad?.folio ||
            `${fechaKey}-${horaKey}-${colKey || "SINCOLAB"}`;

          // ===== Construimos el objeto actividad =====
          const actividad = {
            id: editingActividad?.id ?? 0,
            folio,

            fechaRegistro,
            horaRegistro,
            tipoActividad: data.tipo_solicitud || null,
            areaDestino: data.enviado_area || null,
            tiempoTotalMin,
            tiempoAreaMin,
            prioridad: "Normal",

            colaborador: colaboradorFinal,
            usuarioRegistro: editingActividad?.usuarioRegistro || usuarioLogin,
            usuarioNombre,
            usuarioRol,

            agenteClave:
              data.agente_clave || editingActividad?.agenteClave || null,
            formaSolicitud:
              data.forma_solicitud || editingActividad?.formaSolicitud || null,
            tipoSolicitud:
              data.tipo_solicitud || editingActividad?.tipoSolicitud || null,
            estatus,

            fechaRecepcion: data.fecha || null,
            horaRecepcion: data.hora_recepcion || null,

            fechaEnvioArea: data.fecha_envio_area || null,
            horaEnvioArea: data.hora_envio_area || null,
            fechaRespArea: data.fecha_resp_area || null,
            horaRespArea: data.hora_resp_area || null,

            fechaEnvioAgente: data.fecha_envio_agente || null,
            horaEnvioAgente: data.hora_envio_agente || null,
            asuntoCorreo:
              data.asunto_correo || editingActividad?.asuntoCorreo || null,

            fechaSeguimiento: data.fecha_seguimiento || null,
            comentarios: data.comentarios || null,

            updatedAt: new Date().toISOString(),
            seguimientos,
          };

          return actividad;
        }

        // ====== MODO EDICI√ìN (?id=...) ======
        let editingId = editIdParam ? parseInt(editIdParam, 10) : null;
        let editingActividad = null;

        if (form && editingId != null && !isNaN(editingId)) {
          const lista = loadStoredActivities();
          editingActividad = lista.find(
            (a) => String(a.id) === String(editingId)
          );

          if (editingActividad) {
            const mapping = {
              colaborador: "colaborador",
              fecha: "fechaRecepcion",
              hora_recepcion: "horaRecepcion",
              agente_clave: "agenteClave",
              forma_solicitud: "formaSolicitud",
              tipo_solicitud: "tipoSolicitud",
              enviado_area: "areaDestino",
              fecha_envio_area: "fechaEnvioArea",
              hora_envio_area: "horaEnvioArea",
              fecha_resp_area: "fechaRespArea",
              hora_resp_area: "horaRespArea",
              fecha_envio_agente: "fechaEnvioAgente",
              hora_envio_agente: "horaEnvioAgente",
              estatus: "estatus",
              fecha_seguimiento: "fechaSeguimiento",
              comentarios: "comentarios",
              asunto_correo: "asuntoCorreo",
            };

            Object.entries(mapping).forEach(([fieldName, prop]) => {
              const field = form.elements[fieldName];
              if (field && editingActividad[prop] != null) {
                field.value = editingActividad[prop];
              }
            });

            const esFinalizada = (editingActividad.estatus || "")
              .toLowerCase()
              .includes("final");

            // ===== Paso 1 =====
            const paso1 = document.querySelector(
              '#pane-general section[data-step="1"]'
            );

            if (paso1) {
              if (!esAdmin) {
                // Colaborador: paso 1 solo lectura,
                // pero S√ç puede editar fecha/hora respuesta del √°rea
                paso1
                  .querySelectorAll("input, select, textarea, button")
                  .forEach((el) => {
                    if (el && el.name) el.disabled = true;
                  });

                ["fecha_resp_area", "hora_resp_area"].forEach((n) => {
                  const el = form.elements[n];
                  if (el) el.disabled = false;
                });
              } else {
                // Admin: puede editar todo el paso 1
                paso1
                  .querySelectorAll("input, select, textarea, button")
                  .forEach((el) => {
                    if (el && el.name) el.disabled = false;
                  });
              }
            }

            // ===== Paso 2 (Seguimiento) visible siempre en edici√≥n =====
            const step2Pill = steps.find((s) => s.dataset.step === "2");
            if (step2Pill) step2Pill.classList.remove("d-none");
            const sec2 = document.querySelector(
              '#pane-general section[data-step="2"]'
            );
            if (sec2) {
              sec2.classList.remove("d-none");

              // Fecha seguimiento: autollenada pero solo lectura
              const fseg = form.elements["fecha_seguimiento"];
              if (fseg) {
                fseg.value =
                  editingActividad.fechaSeguimiento ||
                  new Date().toISOString().slice(0, 10);
                fseg.readOnly = true;
                fseg.disabled = true;
                fseg.classList.add("bg-light", "text-muted");
              }

              // Estatus:
              // - Admin: siempre puede cambiarlo
              // - Colaborador: solo si no est√° finalizada
              const est = form.elements["estatus"];
              if (est) {
                if (!esAdmin && esFinalizada) {
                  est.disabled = true;
                  est.classList.add("bg-light", "text-muted");
                } else {
                  est.disabled = false;
                  est.classList.remove("bg-light", "text-muted");
                }
              }
            }

            // Paso inicial en edici√≥n ‚Üí nos vamos directo al Seguimiento si est√° visible
            const targetStep = isStepVisible(2) ? 2 : 1;
            current = targetStep;
            showStep(current);
            computeDurations();
          }
        }
        if (form) {
          // Botones de navegaci√≥n
          btnNext.addEventListener("click", () => {
            if (validateStep()) {
              current = nextVisibleStep(current);
              showStep(current);
              saveDraft();
            }
          });

          if (btnPrev) {
            btnPrev.addEventListener("click", () => {
              current = prevVisibleStep(current);
              showStep(current);
            });
          }

          if (btnSave) {
            btnSave.addEventListener("click", () => saveDraft(true));
          }

          // Submit
          form.addEventListener("submit", (e) => {
            e.preventDefault();

            if (!validateStep()) return;

            // Validaci√≥n final de horarios antes de guardar
            const okHoraArea = validateHoraNegocio(
              form.elements["fecha_envio_area"],
              form.elements["hora_envio_area"],
              document.getElementById("error-hora-envio-area"),
              "Fecha/Hora env√≠o al √Årea"
            );

            const okHoraAgente = validateHoraNegocio(
              form.elements["fecha_envio_agente"],
              form.elements["hora_envio_agente"],
              document.getElementById("error-hora-envio-agente"),
              "Fecha/Hora env√≠o al Agente"
            );

            if (!okHoraArea || !okHoraAgente) {
              // No avanzamos si hay error de horario en alguno
              return;
            }

            const fd = new FormData(form);

            if (editingId != null) {
              const hoy = new Date().toISOString().slice(0, 10);
              fd.set("fecha_seguimiento", hoy);
            }

            const raw = Object.fromEntries(fd.entries());
            const actividad = buildActividadFromForm(raw);

            const lista = loadStoredActivities();

            if (editingId != null && editingActividad) {
              const idx = lista.findIndex(
                (a) => String(a.id) === String(editingId)
              );
              actividad.id = editingActividad.id;
              actividad.createdAt =
                editingActividad.createdAt || actividad.createdAt;
              actividad.folio = editingActividad.folio || actividad.folio;

              if (idx >= 0) {
                lista[idx] = actividad;
              } else {
                lista.push(actividad);
              }

              alert("Actividad actualizada (mock).");
            } else {
              actividad.id = getNextActivityId(lista);
              lista.push(actividad);
              alert("Actividad registrada (mock).");
            }

            saveStoredActivities(lista);
            localStorage.removeItem("helpdesk_draft");
            window.location.href = "actividades.html";
          });

// Enter para navegar / validar y enviar en el √∫ltimo paso
        form.addEventListener("keydown", (e) => {
          if (e.key !== "Enter") return;

          const target = e.target;
          if (!target || !(target instanceof HTMLElement)) return;

          const isTextArea = target.tagName === "TEXTAREA";
          // En textarea dejamos que Enter haga salto de l√≠nea normal
          if (isTextArea && !e.shiftKey) {
            return;
          }

          // Evitamos el submit nativo del navegador
          e.preventDefault();

          const last = lastStep();

          // üî• Si ya estamos en el √∫ltimo paso y NO es Shift+Enter -> enviar form
          if (current === last && !e.shiftKey) {
            if (!validateStep()) return;

            if (typeof form.requestSubmit === "function") {
              form.requestSubmit(); // dispara el submit + listener
            } else {
              form.submit();
            }
            return;
          }

          const currentSection = sections.find(
            (s) => +s.dataset.step === current
          );
          if (!currentSection) return;

          const focusables = Array.from(
            currentSection.querySelectorAll("input, select, textarea, button")
          ).filter((el) => {
            if (!(el instanceof HTMLElement)) return false;
            if (el.disabled) return false;
            if (el.type === "hidden") return false;
            return el.offsetParent !== null;
          });

          const idx = focusables.indexOf(target);

          // Validaci√≥n especial para agente
          if (target === agenteInput && !e.shiftKey) {
            const clave = agenteInput.value.trim();

            if (!/^\d{5}$/.test(clave)) {
              agenteInput.classList.add("is-invalid");
              if (agenteInfo) {
                agenteInfo.textContent =
                  "La clave del agente debe tener exactamente 5 d√≠gitos.";
              }
              return;
            }

            const agente = buscarAgentePorClave(clave);
            if (!agente) {
              agenteInput.classList.add("is-invalid");
              if (agenteInfo) {
                agenteInfo.textContent =
                  "No se encontr√≥ un agente con esa clave.";
              }
              return;
            }

            agenteInput.classList.remove("is-invalid");
            if (agenteInfo) {
              agenteInfo.textContent = `Agente: ${agente.nombre}`;
            }

            if (idx > -1 && idx < focusables.length - 1) {
              focusables[idx + 1].focus();
            }
            return;
          }

          // Shift+Enter -> navega hacia atr√°s / paso anterior
          if (e.shiftKey) {
            if (idx > 0) {
              focusables[idx - 1].focus();
            } else {
              if (current > 1) {
                current = prevVisibleStep(current);
                showStep(current);
              }
            }
            return;
          }

          // Enter normal en pasos que NO son el √∫ltimo
          if (idx > -1 && idx < focusables.length - 1) {
            // Todav√≠a hay campos en el mismo paso
            focusables[idx + 1].focus();
          } else {
            // √öltimo campo del paso actual -> intenta pasar al siguiente
            if (!validateStep()) return;
            current = nextVisibleStep(current);
            showStep(current);
          }
        });

          
          // Recalcular tiempos cuando cambian fechas/horas
          [
            "fecha",
            "hora_recepcion",
            "fecha_envio_area",
            "hora_envio_area",
            "fecha_resp_area",
            "hora_resp_area",
          ].forEach((name) => {
            if (form.elements[name])
              form.elements[name].addEventListener("input", computeDurations);
          });

          // Validaciones en l√≠nea de horario de negocio
          const fechaEnvAreaInput = form.elements["fecha_envio_area"];
          const horaEnvAreaInput = form.elements["hora_envio_area"];
          const fechaEnvAgInput = form.elements["fecha_envio_agente"];
          const horaEnvAgInput = form.elements["hora_envio_agente"];
          const errorHoraArea = document.getElementById(
            "error-hora-envio-area"
          );
          const errorHoraAgente = document.getElementById(
            "error-hora-envio-agente"
          );

          function revalidateHoraArea() {
            validateHoraNegocio(
              fechaEnvAreaInput,
              horaEnvAreaInput,
              errorHoraArea,
              "Fecha/Hora env√≠o al √Årea"
            );
          }

          function revalidateHoraAgente() {
            validateHoraNegocio(
              fechaEnvAgInput,
              horaEnvAgInput,
              errorHoraAgente,
              "Fecha/Hora env√≠o al Agente"
            );
          }

          if (fechaEnvAreaInput)
            fechaEnvAreaInput.addEventListener("change", revalidateHoraArea);
          if (horaEnvAreaInput)
            horaEnvAreaInput.addEventListener("change", revalidateHoraArea);

          if (fechaEnvAgInput)
            fechaEnvAgInput.addEventListener("change", revalidateHoraAgente);
          if (horaEnvAgInput)
            horaEnvAgInput.addEventListener("change", revalidateHoraAgente);

          // Cargar borrador (solo si NO es edici√≥n)
          (function () {
            const draft = JSON.parse(
              localStorage.getItem("helpdesk_draft") || "null"
            );
            if (draft && !editIdParam) {
              current = draft.current || 1;
              for (const [k, v] of Object.entries(draft.data || {})) {
                const el = form.elements[k];
                if (el && !el.value) el.value = v;
              }
            }
            showStep(current);
            computeDurations();
          })();
        }

        // ====== RENOVACIONES (secci√≥n aparte, mock) ======
        const renForm = document.getElementById("renewForm");
        const renFecha = document.getElementById("ren_fecha");
        const renPolizaNueva = document.getElementById("ren_poliza_nueva");
        const renPolizaAnterior = document.getElementById(
          "ren_poliza_anterior"
        );
        const renSaveBtn = document.getElementById("renSave");

        if (renForm) {
          function maybeSetNow() {
            if (!renFecha.value) {
              const now = new Date();
              const pad = (n) => String(n).padStart(2, "0");
              renFecha.value = `${now.getFullYear()}-${pad(
                now.getMonth() + 1
              )}-${pad(now.getDate())}T${pad(now.getHours())}:${pad(
                now.getMinutes()
              )}`;
            }
          }
          renPolizaNueva.addEventListener("input", maybeSetNow);
          renPolizaAnterior.addEventListener("input", maybeSetNow);

          renSaveBtn.addEventListener("click", () => {
            const data = Object.fromEntries(new FormData(renForm));
            localStorage.setItem("helpdesk_renov_draft", JSON.stringify(data));
            if (window.bootstrap) {
              const t = document.createElement("div");
              t.className =
                "toast align-items-center text-bg-success border-0 position-fixed bottom-0 end-0 m-3";
              t.role = "alert";
              t.innerHTML = `<div class="d-flex"><div class="toast-body">Borrador de renovaci√≥n guardado</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
              document.body.appendChild(t);
              const toast = new bootstrap.Toast(t);
              toast.show();
              t.addEventListener("hidden.bs.toast", () => t.remove());
            }
          });

          renForm.addEventListener("submit", (e) => {
            e.preventDefault();
            alert(
              "Renovaci√≥n registrada (mock). Aqu√≠ har√≠amos POST a /renewals"
            );
            localStorage.removeItem("helpdesk_renov_draft");
            renForm.reset();
            if (renFecha) renFecha.value = "";
          });

          (function () {
            const d = JSON.parse(
              localStorage.getItem("helpdesk_renov_draft") || "null"
            );
            if (d) {
              Object.entries(d).forEach(([k, v]) => {
                const el = renForm.elements[k];
                if (el) el.value = v;
              });
            }
          })();
        }
      });
    </script>

    <!-- Router SPA -->
    <script>
      (function () {
        const supportsVT = "startViewTransition" in document;
        async function loadPartial(url) {
          const res = await fetch(url, { credentials: "same-origin" });
          const html = await res.text();
          const doc = new DOMParser().parseFromString(html, "text/html");
          const newMain = doc.querySelector(".app-main");
          const newTitle =
            doc.querySelector("title")?.textContent || document.title;
          return { newMain, newTitle, doc };
        }
        function setActiveLink(url) {
          const links = document.querySelectorAll(".sidebar a[data-spa]");
          links.forEach((a) => a.classList.toggle("active", a.href === url));
        }
        async function navigate(url, push = true) {
          const currentMain = document.querySelector(".app-main");
          const doSwap = async () => {
            const { newMain, newTitle, doc } = await loadPartial(url);
            if (!newMain) {
              location.href = url;
              return;
            } // fallback total
            currentMain.classList.add("is-leaving");
            await new Promise((r) => setTimeout(r, 120));
            currentMain.replaceWith(newMain);
            document.title = newTitle;
            newMain.classList.add("is-entering");
            requestAnimationFrame(() =>
              newMain.classList.add("app-main--ready")
            );
            setTimeout(
              () => newMain.classList.remove("is-entering", "app-main--ready"),
              180
            );
            if (window.bootstrap) {
              document
                .querySelectorAll('[data-bs-toggle="tooltip"]')
                .forEach((el) => new bootstrap.Tooltip(el));
            }
            setActiveLink(new URL(url, location.href).href);
            doc.querySelectorAll("script[data-init]").forEach((s) => {
              try {
                eval(s.textContent);
              } catch (e) {
                console.error(e);
              }
            });
          };
          if (supportsVT) {
            document.startViewTransition(doSwap);
          } else {
            await doSwap();
          }
          if (push) history.pushState({ spa: true }, "", url);
        }
        document.addEventListener("click", (e) => {
          const a = e.target.closest("a[data-spa]");
          if (!a) return;
          const url = a.getAttribute("href");
          if (!url || url.startsWith("http") || url.startsWith("#")) return;
          e.preventDefault();
          navigate(url, true);
        });
        window.addEventListener("popstate", (e) => {
          if (e.state && e.state.spa) {
            navigate(location.href, false);
          } else location.reload();
        });
      })();
    </script>

    <!-- JS Bootstrap -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>







